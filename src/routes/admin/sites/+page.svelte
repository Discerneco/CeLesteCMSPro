<script>
  import { 
    Eye, 
    Globe2, 
    Play, 
    Settings, 
    Upload, 
    Zap,
    ExternalLink,
    Calendar,
    User,
    Server,
    FileDown,
    MoreVertical,
    Edit3,
    Trash2
  } from '@lucide/svelte';
  
  import * as m from '$lib/paraglide/messages';
  import { page } from '$app/stores';
  import { onMount } from 'svelte';

  // Sites data loaded from API
  let sites = $state([]);

  let loading = $state(false);
  let generatingId = $state(null);
  let toggleGenerationId = $state(null);

  // Generate site static files
  async function generateSite(site) {
    generatingId = site.id;
    loading = true;
    
    try {
      console.log(`🏗️ Starting site generation for: ${site.name}`);
      
      // Update site status to building immediately
      const updatedSites = sites.map(s => 
        s.id === site.id 
          ? { ...s, buildStatus: 'building' }
          : s
      );
      sites = updatedSites;
      
      // Call actual site generation API
      const response = await fetch(`/api/sites/${site.id}/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Site generation failed');
      }
      
      console.log(`✅ Site generation completed for: ${site.name}`, result);
      
      // Reload sites to get updated build status
      await loadSites();
      
    } catch (error) {
      console.error('❌ Site generation failed:', error);
      
      // Update build status to error
      const updatedSites = sites.map(s => 
        s.id === site.id 
          ? { ...s, buildStatus: 'error', lastBuildAt: new Date() }
          : s
      );
      sites = updatedSites;
      
      // Show error to user
      alert(`Site generation failed: ${error.message}`);
    } finally {
      loading = false;
      generatingId = null;
    }
  }

  // Preview site
  function previewSite(site) {
    console.log(`👁️ Opening preview for: ${site.name}`);
    
    // Check if site has been generated
    if (site.buildStatus !== 'success') {
      alert('Please generate the site first before previewing.');
      return;
    }
    
    // Open preview in new window/tab using slug
    const previewUrl = site.slug ? `/preview/${site.slug}` : `/preview/${site.id}`;
    window.open(previewUrl, '_blank');
  }

  // Configure site
  function configureSite(site) {
    console.log(`⚙️ Opening configuration for: ${site.name}`);
    // TODO: Navigate to site configuration page
  }

  // Get build status badge class
  function getBuildStatusClass(status) {
    switch (status) {
      case 'building': return 'badge-info';
      case 'success': return 'badge-success';
      case 'error': return 'badge-error';
      default: return 'badge-ghost';
    }
  }

  // Get build status text
  function getBuildStatusText(status) {
    switch (status) {
      case 'building': return 'Building';
      case 'success': return 'Built';
      case 'error': return 'Failed';
      default: return 'Idle';
    }
  }

  // Toggle generation mode
  async function toggleGenerationMode(site) {
    toggleGenerationId = site.id;
    
    try {
      const newMode = site.generationMode === 'dynamic' ? 'static' : 'dynamic';
      
      const response = await fetch(`/api/sites/${site.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...site,
          generationMode: newMode
        })
      });
      
      if (!response.ok) {
        throw new Error('Failed to update generation mode');
      }
      
      const updatedSite = await response.json();
      
      // Update the sites array with the new data
      sites = sites.map(s => s.id === site.id ? updatedSite : s);
      
    } catch (error) {
      console.error('Failed to toggle generation mode:', error);
      alert(`Failed to update generation mode: ${error.message}`);
    } finally {
      toggleGenerationId = null;
    }
  }

  // Format date for display
  function formatDate(date) {
    if (!date) return 'Never';
    return new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(new Date(date));
  }

  // Get generation mode colors and styling
  function getGenerationModeStyle(mode) {
    return mode === 'dynamic' 
      ? { color: 'indigo', bgClass: 'bg-indigo-50 border-indigo-200', textClass: 'text-indigo-700', badgeClass: 'badge-info' }
      : { color: 'emerald', bgClass: 'bg-emerald-50 border-emerald-200', textClass: 'text-emerald-700', badgeClass: 'badge-success' };
  }

  // Load sites from API
  async function loadSites() {
    loading = true;
    try {
      const response = await fetch('/api/sites');
      if (!response.ok) {
        throw new Error(`Failed to load sites: ${response.statusText}`);
      }
      
      const sitesData = await response.json();
      sites = sitesData;
      
      console.log('✅ Loaded sites:', $state.snapshot(sites));
    } catch (error) {
      console.error('❌ Failed to load sites:', error);
    } finally {
      loading = false;
    }
  }

  onMount(() => {
    console.log('📡 Loading sites...');
    loadSites();
  });
</script>

<!-- Page Header -->
<div class="flex justify-between items-start mb-8">
  <div>
    <h1 class="text-3xl font-bold mb-2">{m.sites_title()}</h1>
    <p class="text-base-content/70">{m.sites_subtitle()}</p>
  </div>
  
  <div class="flex gap-3">
    <button class="btn btn-outline" disabled>
      <Settings class="h-4 w-4" />
      {m.sites_global_settings()}
    </button>
    
    <button class="btn btn-primary" disabled>
      <Globe2 class="h-4 w-4" />
      {m.sites_create_new()}
    </button>
  </div>
</div>

<!-- Sites List -->
<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
  {#each sites as site (site.id)}
    {@const modeStyle = getGenerationModeStyle(site.generationMode)}
    <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-all duration-200 border-2 {modeStyle.bgClass}">
      <div class="card-body">
        <!-- Enhanced Site Header -->
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <h3 class="card-title text-lg truncate {modeStyle.textClass}">
                {site.name}
              </h3>
              {#if site.isDefault}
                <div class="badge badge-primary badge-sm">Default</div>
              {/if}
            </div>
            
            {#if site.domain}
              <p class="text-sm text-base-content/60 truncate">
                <ExternalLink class="h-3 w-3 inline mr-1" />
                {site.domain}
              </p>
            {/if}
            
            {#if site.description}
              <p class="text-xs text-base-content/50 mt-1 line-clamp-2">
                {site.description}
              </p>
            {/if}
          </div>
          
          <!-- Dropdown Menu -->
          <div class="dropdown dropdown-end">
            <button class="btn btn-ghost btn-sm btn-circle">
              <MoreVertical class="h-4 w-4" />
            </button>
            <ul class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-10">
              <li>
                <button onclick={() => configureSite(site)}>
                  <Edit3 class="h-4 w-4" />
                  Edit Site
                </button>
              </li>
              <li>
                <button class="text-error hover:text-error">
                  <Trash2 class="h-4 w-4" />
                  Delete Site
                </button>
              </li>
            </ul>
          </div>
        </div>

        <!-- Generation Mode Toggle -->
        <div class="bg-base-200 rounded-lg p-3 mb-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              {#if site.generationMode === 'dynamic'}
                <Server class="h-4 w-4 text-indigo-600" />
                <span class="text-sm font-medium text-indigo-700">Dynamic Site</span>
              {:else}
                <FileDown class="h-4 w-4 text-emerald-600" />
                <span class="text-sm font-medium text-emerald-700">Static Site</span>
              {/if}
            </div>
            
            <label class="swap swap-flip">
              <input 
                type="checkbox" 
                checked={site.generationMode === 'static'}
                onchange={() => toggleGenerationMode(site)}
                disabled={toggleGenerationId === site.id || loading}
              />
              
              <!-- Dynamic Mode Icon -->
              <div class="swap-off">
                <div class="badge {site.generationMode === 'dynamic' ? 'badge-info' : 'badge-ghost'} badge-sm gap-1">
                  <Server class="h-3 w-3" />
                  Dynamic
                </div>
              </div>
              
              <!-- Static Mode Icon -->
              <div class="swap-on">
                <div class="badge {site.generationMode === 'static' ? 'badge-success' : 'badge-ghost'} badge-sm gap-1">
                  <FileDown class="h-3 w-3" />
                  Static
                </div>
              </div>
            </label>
          </div>
          
          <!-- Generation Mode Description -->
          <p class="text-xs text-base-content/60 mt-2">
            {#if site.generationMode === 'dynamic'}
              Server-side rendering with real-time content updates
            {:else}
              Pre-built HTML files for maximum performance and CDN caching
            {/if}
          </p>
        </div>

        <!-- Enhanced Site Metadata -->
        <div class="grid grid-cols-2 gap-3 text-xs text-base-content/60 mb-4">
          <div class="space-y-1">
            <div class="flex items-center gap-1">
              <User class="h-3 w-3" />
              <span class="truncate">Template: {site.templateName || 'None'}</span>
            </div>
            
            <div class="flex items-center gap-1">
              <div class="badge {getBuildStatusClass(site.buildStatus)} badge-xs">
                {getBuildStatusText(site.buildStatus)}
              </div>
            </div>
          </div>
          
          <div class="space-y-1">
            {#if site.lastBuildAt}
              <div class="flex items-center gap-1">
                <Calendar class="h-3 w-3" />
                <span class="truncate">Built: {formatDate(site.lastBuildAt)}</span>
              </div>
            {/if}
          </div>
        </div>

        <!-- Enhanced Action Buttons -->
        <div class="card-actions justify-end gap-2">
          <button 
            class="btn btn-ghost btn-sm"
            onclick={() => previewSite(site)}
            disabled={loading}
          >
            <Eye class="h-3 w-3" />
            Preview
          </button>
          
          <button 
            class="btn btn-outline btn-sm"
            onclick={() => configureSite(site)}
            disabled={loading}
          >
            <Settings class="h-3 w-3" />
            Configure
          </button>
          
          <button 
            class="btn {site.generationMode === 'dynamic' ? 'btn-info' : 'btn-success'} btn-sm"
            onclick={() => generateSite(site)}
            disabled={loading}
          >
            {#if generatingId === site.id}
              <span class="loading loading-spinner loading-xs"></span>
              {#if toggleGenerationId === site.id}
                Updating...
              {:else}
                Building
              {/if}
            {:else}
              <Zap class="h-3 w-3" />
              {site.generationMode === 'dynamic' ? 'Deploy' : 'Generate'}
            {/if}
          </button>
        </div>
      </div>
    </div>
  {/each}
</div>

<!-- Empty State (if no sites) -->
{#if sites.length === 0}
  <div class="text-center py-16">
    <Globe2 class="h-16 w-16 mx-auto text-base-content/30 mb-4" />
    <h3 class="text-xl font-semibold mb-2">{m.sites_empty_title()}</h3>
    <p class="text-base-content/70 mb-6">{m.sites_empty_description()}</p>
    <button class="btn btn-primary">
      <Globe2 class="h-4 w-4" />
      {m.sites_create_first()}
    </button>
  </div>
{/if}

<!-- Loading Overlay (if needed) -->
{#if loading && !generatingId}
  <div class="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="bg-base-100 p-8 rounded-lg shadow-xl text-center">
      <span class="loading loading-spinner loading-lg"></span>
      <p class="mt-4 text-base-content/70">{m.sites_loading()}</p>
    </div>
  </div>
{/if}

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Color-coded site cards */
  .bg-indigo-50 {
    background-color: rgb(238 242 255);
  }
  
  .border-indigo-200 {
    border-color: rgb(199 210 254);
  }
  
  .text-indigo-700 {
    color: rgb(67 56 202);
  }
  
  .text-indigo-600 {
    color: rgb(79 70 229);
  }
  
  .bg-emerald-50 {
    background-color: rgb(236 253 245);
  }
  
  .border-emerald-200 {
    border-color: rgb(167 243 208);
  }
  
  .text-emerald-700 {
    color: rgb(4 120 87);
  }
  
  .text-emerald-600 {
    color: rgb(5 150 105);
  }

  /* Enhanced hover effects */
  .card:hover {
    transform: translateY(-2px);
  }

  /* Swap animation improvements */
  .swap {
    cursor: pointer;
    user-select: none;
  }
  
  .swap input[type="checkbox"]:disabled ~ * {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>